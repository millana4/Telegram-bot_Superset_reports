# Телеграм-бот для рассылки отчетов из Superset

## Назначение
Telegram-бот позволяет автоматически отправлять отчёты с BI-платформы Apache Superset конечным пользователям через 
технические email-аккаунты. Он реагирует на входящие письма с PDF-вложениями и рассылает отчёты в Telegram.

## Как работает бот
- Новые пользователи добавляются в конфигурационную таблицу Seatable.
- Раз в сутки запускается синхронизация: Seatable передает по API боту данные о пользователях и об их подписках на 
ящики. Данные записываются в базу данных Postgres. Новые пользователи добавляются, а пользователи, которых удалили из 
Seatable (сотрудник уволился), удаляются из БД. Удаленные из БД пользователи больше не получают отчеты.
- Пользователи запускают бот и авторизуются по номеру телефона. В момент авторизации в БД записывается Telegram ID 
пользователя.
- Бот «слушает» ящики через IMAP в режиме IDLE.
- Superset отправляет отчёты на email-ящики.

- Когда приходит письмо с вложением PDF, бот:

  - извлекает тему и файлы в формате PDF;
  - находит нужных Telegram-получателей в базе по email;

  - рассылает отчёт пользователям по их Telegram ID, которые получает из базы.


## Основные компоненты

![](sset-bot-scheme.png)

**Seatable** — конфигурационная база. Используется для хранения параметров доступа и связей между пользователями 
и ящиками.<br>

**PostgreSQL** — хранит Telegram-ID пользователей и обрабатывает запросы при рассылке. Каждое обращение к БД 
обрабатывается в рамках асинхронной сессии.<br>

**IMAP Idle Listener** — слушает входящие письма на почтовых ящиках через IMAP IDLE. Каждый ящик запускается в отдельном 
потоке.<br>

**Telegram Bot** — отвечает на команды пользователей, рассылает вложения из писем.


